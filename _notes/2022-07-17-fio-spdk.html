---
layout: post
title: "Setting up fio for SPDK"
short: "Setting up fio for SPDK"
category: benchmarking
status: Stale
---

<div id="outline-container-org1f1de3c" class="outline-2">
<h2 id="org1f1de3c"><span class="section-number-2">1.</span> !!!This page requires cleaning!!!</h2>
</div>

<div id="outline-container-org2393b44" class="outline-2">
<h2 id="org2393b44"><span class="section-number-2">2.</span> Setup FIO For SPDK in steps</h2>
<div class="outline-text-2" id="text-2">
<p>
Setting up fio for SPDK is at the moment not a fun experience. It involves issues with linking, paths and segfaults.
The following works (on my machine):
</p>

<ol class="org-ol">
<li>Clone SPDK RECURSIVELY (follow <a href="https://spdk.io/doc/getting_started.html">https://spdk.io/doc/getting_started.html</a>)</li>
<li>Be sure to setup all pkgdeps in the spdk repo not just a few</li>
<li>Clone fio anywhere (<a href="https://github.com/axboe/fio">https://github.com/axboe/fio</a>)</li>
<li>move to fio directory</li>
<li>call  `./configure` in the fio directory (not specified but absolutely necessary!)</li>
<li>call `make -j $nprocs` in fio directory</li>
<li>call `sudo make install` IF fio needs to be installed</li>
<li>move to spdk directory again</li>
<li>call `./configure &#x2013;with-fio=&lt;absolute path to earlier installed fio repo&gt;` inside SPDK dir. Do NOT use a relative path.</li>
<li>call `make -j` in SPDK dir</li>
<li><p>
when running fio with SPDK plugin only this worked for me&#x2026;:
</p>
<div class="org-src-container">
<pre class="src src-bash">    <span style="color: #fabd2f;">sudo</span> <span style="color: #83a598;">LD_LIBRARY_PATH</span>=&lt;SPDK_DIR&gt;/build/lib <span style="color: #83a598;">LD_PRELOAD</span>=&lt;SPDK_DIR&gt;/build/fio/spdk_nvme fio
</pre>
</div></li>
</ol>

<p>
In order to use ZNS devices for SPDK do:
</p>

<ol class="org-ol">
<li><p>
Get NVMe trid:
</p>
<div class="org-src-container">
<pre class="src src-bash">   <span style="color: #83a598;">trid</span>=<span style="color: #fabd2f;">ls</span> -l /sys/block/$<span style="color: #83a598;">dev</span>/device/device | awk <span style="color: #b8bb26;">'{split($11,dev,"/"); print dev[4]}'</span><span style="color: #ebdbb2; font-weight: bold;">`</span>
</pre>
</div></li>
<li><p>
ONLY bind this trid (really why is the default binding to use all devices?):
</p>
<div class="org-src-container">
<pre class="src src-bash">   <span style="color: #83a598;">PCI_ALLOWED</span>=$<span style="color: #83a598;">trid</span> &lt;SPDK_DIR&gt;/scripts/setup.sh
</pre>
</div></li>
<li><p>
Move trid to dot separated instead of colon&#x2026; (required by fio)
</p>
<div class="org-src-container">
<pre class="src src-bash">   <span style="color: #83a598;">triddot</span>=$<span style="color: #fe8019;">(</span><span style="color: #fabd2f;">echo</span> $<span style="color: #83a598;">trid</span> | sed <span style="color: #b8bb26;">'s/\:/./g'</span><span style="color: #fe8019;">)</span>
</pre>
</div></li>
<li><p>
Call the following to run with ZNS:
</p>
<div class="org-src-container">
<pre class="src src-bash">       <span style="color: #fabd2f;">sudo</span> <span style="color: #83a598;">LD_LIBRARY_PATH</span>=&lt;SPDK_DIR&gt;/build/lib <span style="color: #b8bb26;">\</span>
           <span style="color: #83a598;">LD_PRELOAD</span>=&lt;SPDK_DIR&gt;/build/fio/spdk_nvme <span style="color: #b8bb26;">\</span>
           fio <span style="color: #83a598;">filename</span>=<span style="color: #83a598;">trtype</span>=PCIe <span style="color: #83a598;">traddr</span>=$<span style="color: #83a598;">triddot</span> <span style="color: #83a598;">ns</span>=<span style="color: #d3869b; font-weight: bold;">1</span> <span style="color: #83a598;">ioengine</span>=spdk <span style="color: #83a598;">thread</span>=<span style="color: #d3869b; font-weight: bold;">1</span>
</pre>
</div>
<p>
^^ For this remember ns is 1-indexed for unexplained reasons in fio<sub>spdk</sub>, not 0-indexed&#x2026; probably add +1 to your nsid. Also always use thread=1, SPDK does not work with multiple processes, requiring thread parallelism instead.
</p></li>
</ol>
</div>
</div>
